<!DOCTYPE html>
{% load dict_extras %}
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cat√°logo ‚Äî Caicai</title>

  <!-- Tailwind por CDN (suficiente para proyecto acad√©mico) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Mensajes de Django */
    .success { background-color: #dcfce7; color: #166534; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; }
    .error { background-color: #fee2e2; color: #991b1b; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; }

    /* Animaci√≥n simple para "notificaci√≥n carrito" */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .animate-slideIn { animation: slideIn 0.2s ease-out; }

    /* Banner carrusel */
    .banner-track { animation: banner-scroll 36s linear infinite; }
    @keyframes banner-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .banner-img { width: 100%; height: 100%; object-fit: contain; object-position: center; padding: 6px; }
  </style>
</head>
<body class="bg-white text-gray-900">

  <!-- HEADER -->
  <header class="border-b shadow-sm bg-white sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between mb-4 text-sm">
        <!-- Redes (decorativo) -->
        <div class="flex gap-3 text-gray-500">
          <a href="https://www.instagram.com/caicaiclothing/" target="_blank" class="cursor-pointer hover:text-pink-600 font-semibold">IG</a>
        </div>

        <!-- Zona de usuario / sesi√≥n -->
        <div class="flex items-center gap-4 text-xs sm:text-sm">
          {% if user.is_authenticated %}
            <span>
              Sesi√≥n: <strong>{{ user.username }}</strong>
              {% if user.bloqueado %}<span class="text-red-600 font-semibold">(bloqueado)</span>{% endif %}
            </span>

            {% if not user.bloqueado %}
              <a href="{% url 'editar_perfil' %}" class="hover:text-gray-700">Mi perfil</a>
              <a href="{% url 'mis_pedidos' %}" class="hover:text-gray-700">Mis pedidos</a>
            {% endif %}

            {% if user.is_staff or user.is_superuser %}
              <a href="{% url 'admin_dashboard' %}" class="text-amber-600 hover:text-amber-700 font-semibold">
                Panel de administrador
              </a>
            {% endif %}

            <a href="{% url 'logout_unificado' %}" class="hover:text-gray-700 font-semibold">Cerrar sesi√≥n</a>
          {% elif request.session.admin_id %}
            <span>Sesi√≥n: <strong>Admin</strong></span>
            <a href="{% url 'admin_dashboard' %}" class="text-amber-600 hover:text-amber-700 font-semibold">
              Panel de administrador
            </a>
            <a href="{% url 'logout_unificado' %}" class="hover:text-gray-700 font-semibold">Cerrar sesi√≥n</a>
          {% else %}
            <a href="{% url 'login_unificado' %}" class="hover:text-gray-700 font-semibold">Iniciar sesi√≥n</a>
            <span class="text-gray-400">|</span>
            <a href="{% url 'registro_cliente' %}" class="hover:text-gray-700">Registrarse</a>
          {% endif %}
        </div>

        <!-- Carrito -->
        <div class="relative cursor-pointer" onclick="window.location.href='{% url 'ver_carrito' %}'">
          <span class="text-xs sm:text-sm font-medium flex items-center gap-1 hover:text-gray-700">
            üõí Carrito
            <span id="carrito-count"
                  class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-500 text-white text-xs font-bold">
              {{ cart_count|default:0 }}
            </span>
          </span>
          <!-- contenedor para notificaci√≥n -->
          <div id="carrito-notificacion" class="hidden absolute top-8 right-0 bg-green-500 text-white px-4 py-2 rounded-lg shadow-xl whitespace-nowrap z-50 animate-slideIn text-xs">
            <span class="font-bold">¬°Agregado al carrito!</span>
          </div>
        </div>
      </div>

      <!-- Logo -->
      <div class="flex justify-center mb-4">
        <div class="w-28 h-28 bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg flex items-center justify-center shadow-lg">
          <span class="text-white font-bold text-2xl">CAICAI</span>
        </div>
      </div>

      <!-- MEN√ö / NAV -->
      <nav class="flex justify-center gap-4 sm:gap-8 text-[11px] sm:text-sm font-medium flex-wrap text-gray-700">
        <a href="{% url 'home' %}" class="hover:text-gray-900 transition-colors">INICIO</a>
        <a href="{% url 'catalogo' %}" class="hover:text-gray-900 transition-colors">CAT√ÅLOGO</a>
        <a href="{% url 'solicitud_confeccion' %}" class="hover:text-teal-700 transition-colors font-bold text-teal-700">
          CONFECCI√ìN A MEDIDA
        </a>
      </nav>
    </div>
  </header>

  <!-- BANNER CARRUSEL -->
  <section class="w-full h-48 sm:h-60 overflow-hidden border-b">
    <div class="flex banner-track gap-2 pl-2">
      {% for img in banner_images %}
        <div class="shrink-0 basis-52 sm:basis-64 h-48 sm:h-60 bg-gradient-to-br from-gray-100 to-gray-50 flex items-center justify-center border border-gray-200 overflow-hidden rounded">
          {% if img %}
            <img src="{{ img }}" alt="Banner {{ forloop.counter }}" class="banner-img">
          {% else %}
            <span class="text-3xl font-bold text-gray-300">FOTO {{ forloop.counter }}</span>
          {% endif %}
        </div>
      {% endfor %}
      {% for img in banner_images %}
        <div class="shrink-0 basis-52 sm:basis-64 h-48 sm:h-60 bg-gradient-to-br from-gray-100 to-gray-50 flex items-center justify-center border border-gray-200 overflow-hidden rounded">
          {% if img %}
            <img src="{{ img }}" alt="Banner {{ forloop.counter }}" class="banner-img">
          {% else %}
            <span class="text-3xl font-bold text-gray-300">FOTO {{ forloop.counter }}</span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </section>

  <!-- FILTROS (usa las variables de tu backend) -->
  <section class="bg-gray-50 border-b py-6">
    <div class="max-w-7xl mx-auto px-4">
      <!-- mensajes Django -->
      {% if messages %}
        <div class="mb-4">
          {% for message in messages %}
            <div class="{% if message.tags == 'success' %}success{% else %}error{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="get" action="{% url 'catalogo' %}" class="flex flex-wrap gap-3 items-center justify-center">
        <input
          type="text"
          name="q"
          value="{{ query|default:'' }}"
          placeholder="Buscar productos..."
          class="px-4 py-2 border rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-gray-300"
        >

        <select
          name="categoria"
          class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-300">
          <option value="">Todas las categor√≠as</option>
          {% for c in categorias %}
            <option value="{{ c.id }}" {% if categoria_id == c.id|stringformat:'s' %}selected{% endif %}>
              {{ c.nombre }}
            </option>
          {% endfor %}
        </select>

        <button
          type="submit"
          class="px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm font-semibold">
          Filtrar
        </button>
      </form>
    </div>
  </section>

  <!-- CAT√ÅLOGO -->
  <main class="max-w-7xl mx-auto px-4 py-12">
    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-10 tracking-tight">
      CAT√ÅLOGO DE PRODUCTOS
    </h2>

    {% if productos %}
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for p in productos %}
          <div class="group relative">
            <!-- Imagen del producto -->
            <div class="relative aspect-square bg-gradient-to-br from-gray-200 to-gray-100 rounded-xl overflow-hidden shadow-md flex items-center justify-center">
              {% if p.imagen %}
                <img src="{{ p.imagen.url }}" alt="{{ p.nombre }}" class="w-full h-full object-cover">
              {% else %}
                <span class="text-4xl font-bold text-gray-300">FOTO</span>
              {% endif %}
            </div>

            <!-- Info producto -->
            <div class="text-center mt-3">
              <p class="text-[11px] uppercase tracking-wide text-gray-500 mb-1">
                {{ p.categoria.nombre }}
              </p>
              <h3 class="font-semibold text-sm mb-1 line-clamp-2">
                {{ p.nombre }}
              </h3>
              <p class="text-lg font-bold text-gray-900">
                {{ p.precio|precio_clp }}
              </p>
            </div>

            <!-- Bot√≥n agregar al carrito -->
            <div class="mt-3 flex flex-col items-center gap-2">
              {% if user.is_authenticated and user.bloqueado %}
                <button
                  type="button"
                  disabled
                  class="w-full py-2 text-xs font-semibold rounded-lg bg-gray-300 text-gray-600 cursor-not-allowed"
                  title="Cuenta bloqueada">
                  Cuenta bloqueada
                </button>
              {% else %}
                <form
                  class="add-to-cart w-full flex items-center justify-center gap-2"
                  action="{% url 'agregar_al_carrito' p.id %}"
                  method="post">
                  {% csrf_token %}
                  <input
                    type="number"
                    name="cantidad"
                    value="1"
                    min="1"
                    class="w-16 px-2 py-1 border rounded-lg text-sm text-center focus:outline-none focus:ring-2 focus:ring-gray-300">
                  <button
                    type="submit"
                    class="flex-1 py-2 text-xs sm:text-sm font-semibold rounded-lg bg-black text-white hover:bg-gray-800 transition-colors">
                    Agregar al carrito
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center text-gray-500 mt-10">
        No hay productos disponibles.
      </p>
    {% endif %}
  </main>

<!-- SECCI√ìN CONFECCI√ìN A MEDIDA -->
  <section id="confeccion" class="bg-gradient-to-r from-teal-50 to-blue-50 py-16">
    <div class="max-w-4xl mx-auto px-4">
      <div class="text-center mb-8">
        <div class="w-16 h-16 rounded-full bg-teal-600 flex items-center justify-center mx-auto mb-4">
          <span class="text-white text-2xl">‚úÇ</span>
        </div>
        <h2 class="text-2xl sm:text-3xl font-bold mb-4">SERVICIO DE CONFECCI√ìN A MEDIDA</h2>
        <p class="text-gray-600 max-w-2xl mx-auto text-sm sm:text-base">
          ¬øTienes un dise√±o especial en mente? Tambi√©n puedes solicitar una prenda personalizada.
          Cu√©ntanos el tipo de prenda, tu estilo y los detalles que quieres, y revisaremos tu solicitud.
        </p>
      </div>

      <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8">
        <h3 class="text-lg sm:text-xl font-bold mb-4">Solicita tu prenda personalizada</h3>
        <p class="text-gray-600 text-sm sm:text-base mb-4">
          A trav√©s de nuestro formulario de confecci√≥n a medida puedes:
        </p>
        <ul class="list-disc list-inside mt-1 mb-5 text-gray-600 text-sm sm:text-base space-y-1">
          <li>Elegir el tipo de prenda (polera, poler√≥n, pantal√≥n, etc.).</li>
          <li>Describir el dise√±o que tienes en mente (colores, estilo, detalles especiales).</li>
          <li>Dejar tus datos de contacto para coordinar tiempos y valores.</li>
        </ul>

        <div class="text-center">
          <a
            href="{% url 'solicitud_confeccion' %}"
            class="inline-flex items-center justify-center px-6 py-3 bg-teal-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-teal-700 transition-colors shadow-md"
          >
            Ir al formulario de confecci√≥n
          </a>
        </div>
      </div>
    </div>
  </section>


  <!-- FOOTER SIMPLE -->
  <footer class="bg-white border-t py-8">
    <div class="max-w-7xl mx-auto px-4 text-center text-xs sm:text-sm text-gray-500">
      <div class="flex justify-center items-center gap-3 mb-3">
        <div class="w-12 h-12 bg-gray-800 rounded flex items-center justify-center">
          <span class="text-white font-bold text-sm">CAICAI</span>
        </div>
      </div>
      <p>¬© 2025 Caicai¬Æ ‚Äî Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- JS: desvanecer mensajes y AJAX para carrito (reutilizamos l√≥gica anterior) -->
  <script>
    // Desvanecer mensajes
    setTimeout(() => {
      document.querySelectorAll('.success, .error').forEach(el => {
        el.style.transition = 'opacity 0.5s';
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 500);
      });
    }, 5000);
  </script>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    document.querySelectorAll('form.add-to-cart').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const res = await fetch(form.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          },
          body: fd
        });
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.ok) {
          const badge = document.getElementById('carrito-count');
          if (badge) badge.textContent = data.count;

          const notif = document.getElementById('carrito-notificacion');
          if (notif) {
            notif.classList.remove('hidden');
            setTimeout(() => { notif.classList.add('hidden'); }, 2500);
          }
        } else if (data && data.error) {
          alert(data.error);
        }
      });
    });
  </script>
</body>
</html>
