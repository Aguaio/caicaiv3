<!DOCTYPE html>
{% load dict_extras %}
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Productos — Panel Caicai</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- HEADER -->
  <header class="border-b shadow-sm bg-white">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <button onclick="window.location.href='{% url 'home' %}'"
                class="flex items-center gap-2 text-gray-600 hover:text-gray-900 text-sm">
          <span class="text-lg">⌂</span>
          <span class="font-medium">Ver tienda</span>
        </button>

        <div class="w-24 h-24 bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg flex items-center justify-center shadow-lg">
          <span class="text-white font-bold text-xl">CAICAI</span>
        </div>

        <div class="flex items-start justify-end gap-3">
          {% include 'core/partials/low_stock_alert.html' %}
          <div class="text-right text-xs sm:text-sm">
            {% if user.is_authenticated %}
              <p>Sesión: <strong>{{ user.username }}</strong></p>
              <p class="mt-1">
                <a href="{% url 'logout_unificado' %}" class="hover:text-gray-700 font-semibold">Cerrar sesión</a>
              </p>
            {% elif request.session.admin_id %}
              <p>Sesión: <strong>Admin</strong></p>
              <p class="mt-1">
                <a href="{% url 'logout_unificado' %}" class="hover:text-gray-700 font-semibold">Cerrar sesión</a>
              </p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs sm:text-sm text-gray-500">
        <div>
          <p class="uppercase tracking-wide font-semibold text-gray-600">Gestión de productos</p>
          <p>Administra los productos que se muestran en el catálogo de Caicai.</p>
        </div>
      </div>
    </div>
  </header>

  <!-- CONTENIDO -->
  <main class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex flex-wrap gap-3 text-xs sm:text-sm text-gray-600 mb-6">
        <a href="{% url 'admin_dashboard' %}" class="hover:text-gray-900">Panel</a>
        <span class="font-semibold text-gray-900">Productos</span>
        <a href="{% url 'categorias_list' %}" class="hover:text-gray-900">Categorías</a>
        <a href="{% url 'ventas_panel' %}" class="hover:text-gray-900">Ventas</a>
        <a href="{% url 'pedidos_list' %}" class="hover:text-gray-900">Pedidos</a>
        <a href="{% url 'solicitudes_confeccion_list' %}" class="hover:text-gray-900">Confección</a>
        <a href="{% url 'historial_clientes' %}" class="hover:text-gray-900">Historial de clientes</a>
      </nav>
      {% if messages %}
        <div class="mb-4">
          {% for message in messages %}
            <div class="px-4 py-2 rounded-lg text-sm
                        {% if message.tags == 'success' %}
                          bg-emerald-50 text-emerald-700
                        {% else %}
                          bg-red-50 text-red-700
                        {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl sm:text-2xl font-bold">Productos</h1>
        <div class="flex items-center gap-3">
          {% if show == 'inactivos' %}
            <a href="?show=activos" class="hidden sm:inline-flex px-3 py-2 rounded-lg border border-gray-300 text-sm text-gray-700 hover:bg-gray-100">
              Ver activos
            </a>
          {% else %}
            <a href="?show=inactivos" class="hidden sm:inline-flex px-3 py-2 rounded-lg border border-gray-300 text-sm text-gray-700 hover:bg-gray-100">
              Ver deshabilitados
            </a>
          {% endif %}
          <form method="get" class="flex items-center gap-2 text-sm flex-wrap justify-end">
            <label for="show" class="text-gray-600 text-xs sm:text-sm">Estado:</label>
            <select id="show" name="show" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-300">
              <option value="activos" {% if show == 'activos' %}selected{% endif %}>Activos</option>
              <option value="inactivos" {% if show == 'inactivos' %}selected{% endif %}>Deshabilitados</option>
              <option value="todos" {% if show == 'todos' %}selected{% endif %}>Todos</option>
            </select>
            <label for="sort" class="text-gray-600 text-xs sm:text-sm">Ordenar por:</label>
            <select id="sort" name="sort" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-300">
              <option value="" {% if not sort %}selected{% endif %}>ID</option>
              <option value="categoria" {% if sort == 'categoria' %}selected{% endif %}>Categoría</option>
              <option value="stock_desc" {% if sort == 'stock_desc' %}selected{% endif %}>Stock (mayor a menor)</option>
              <option value="stock_asc" {% if sort == 'stock_asc' %}selected{% endif %}>Stock (menor a mayor)</option>
              <option value="precio_desc" {% if sort == 'precio_desc' %}selected{% endif %}>Precio (alto a bajo)</option>
              <option value="precio_asc" {% if sort == 'precio_asc' %}selected{% endif %}>Precio (bajo a alto)</option>
              <option value="nombre" {% if sort == 'nombre' %}selected{% endif %}>Nombre</option>
            </select>
            <button type="submit" class="px-3 py-2 rounded-lg bg-gray-900 text-white font-semibold hover:bg-gray-800">Aplicar</button>
          </form>
          <a href="{% url 'producto_create' %}"
             class="inline-flex items-center px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold hover:bg-gray-800">
            + Nuevo producto
          </a>
        </div>
      </div>

      {% if productos %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 border-b">
              <tr class="text-left text-gray-600">
                <th class="px-4 py-3">ID</th>
                <th class="px-4 py-3">Nombre</th>
                <th class="px-4 py-3">Categoría</th>
                <th class="px-4 py-3">Precio</th>
                <th class="px-4 py-3">Stock</th>
                <th class="px-4 py-3">Estado</th>
                <th class="px-4 py-3 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for p in productos %}
                <tr class="border-b last:border-0 hover:bg-gray-50 {% if not p.activo %}bg-gray-100 text-gray-500{% endif %}">
                  <td class="px-4 py-3 text-xs text-gray-500">{{ p.id }}</td>
                  <td class="px-4 py-3 font-medium {% if not p.activo %}text-gray-600{% else %}text-gray-900{% endif %}">{{ p.nombre }}</td>
                  <td class="px-4 py-3 {% if not p.activo %}text-gray-500{% else %}text-gray-700{% endif %}">
                    {% if p.categoria %}
                      {{ p.categoria.nombre }}
                    {% else %}
                      <span class="text-red-600 font-semibold">Sin categoría</span>
                    {% endif %}
                  </td>
                  <td class="px-4 py-3 text-gray-900 font-semibold">
                    {{ p.precio|precio_clp }}
                  </td>
                  <td class="px-4 py-3 {% if not p.activo %}text-gray-500{% else %}text-gray-700{% endif %}">
                    {{ p.stock|default:"-" }}
                  </td>
                  <td class="px-4 py-3 text-gray-700">
                    {% if p.activo %}
                      <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Activo</span>
                    {% else %}
                      <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-700 border border-gray-300">Deshabilitado</span>
                    {% endif %}
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex justify-end gap-2">
                      <a href="{% url 'producto_edit' p.id %}"
                         class="px-3 py-1 rounded-lg text-xs font-semibold bg-gray-900 text-white hover:bg-gray-800">
                        Editar
                      </a>
                      {% if p.activo %}
                        <form action="{% url 'producto_delete' p.id %}" method="post" class="inline-flex" id="form-disable-{{ p.id }}">
                          {% csrf_token %}
                          <button type="button"
                                  data-target="form-disable-{{ p.id }}"
                                  data-message="¿Deshabilitar este producto? Dejará de mostrarse en el catálogo."
                                  class="confirm-action px-3 py-1 rounded-lg text-xs font-semibold bg-red-100 text-red-700 hover:bg-red-200">
                            Deshabilitar
                          </button>
                        </form>
                      {% else %}
                        <form action="{% url 'producto_habilitar' p.id %}" method="post" class="inline-flex" id="form-enable-{{ p.id }}">
                          {% csrf_token %}
                          <button type="button"
                                  data-target="form-enable-{{ p.id }}"
                                  data-message="¿Habilitar nuevamente este producto?"
                                  class="confirm-action px-3 py-1 rounded-lg text-xs font-semibold bg-emerald-100 text-emerald-700 hover:bg-emerald-200">
                            Habilitar
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-gray-500 text-sm mt-4">
          No hay productos registrados todavía.
        </p>
      {% endif %}
    </div>
  </main>

  <footer class="bg-white border-t py-6 mt-10">
    <div class="max-w-7xl mx-auto px-4 text-center text-xs sm:text-sm text-gray-500">
      <p>© 2025 Caicai — Panel de productos.</p>
    </div>
  </footer>

  <!-- Modal de confirmación -->
  <div id="confirm-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-5 transform transition-transform duration-150 scale-100" id="confirm-modal">
      <p id="confirm-message" class="text-sm text-gray-800 mb-4"></p>
      <div class="flex justify-end gap-3 text-sm">
        <button id="confirm-cancel" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">Cancelar</button>
        <button id="confirm-accept" class="px-4 py-2 rounded-lg bg-gray-900 text-white font-semibold hover:bg-gray-800">Aceptar</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const overlay = document.getElementById('confirm-overlay');
      const msg = document.getElementById('confirm-message');
      const cancelBtn = document.getElementById('confirm-cancel');
      const acceptBtn = document.getElementById('confirm-accept');
      let pendingFormId = null;

      const modal = document.getElementById('confirm-modal');
      const close = () => {
        overlay.classList.add('hidden');
        pendingFormId = null;
      };

      document.querySelectorAll('.confirm-action').forEach(btn => {
        btn.addEventListener('click', () => {
          pendingFormId = btn.getAttribute('data-target');
          msg.textContent = btn.getAttribute('data-message') || '¿Confirmas esta acción?';
          overlay.classList.remove('hidden');
          modal.classList.remove('scale-95');
        });
      });

      cancelBtn.addEventListener('click', close);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) close();
      });

      acceptBtn.addEventListener('click', () => {
        if (!pendingFormId) return close();
        const form = document.getElementById(pendingFormId);
        if (form) form.submit();
        close();
      });
    })();
  </script>
</body>
</html>
